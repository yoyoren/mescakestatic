(function(){var v=location.href.split("addressid=").pop();var i;var g=$("#address_container");var l='<p class="address-detail address_item" data-id="<%=data.address_id%>" id="address_<%=data.address_id%>"							data-id="<%=data.address_id%>"							data-address="<%=data.address%>"							data-tel="<%=data.mobile%>"							data-contact="<%=data.consignee%>"							data-city="<%=data.city%>"							data-district="<%=data.district%>"						>						北京市-<%=data.cityName%> <%=data.districtName%> <%=data.address%><br>						<%=data.consignee%> <span class="address-num"><%=data.mobile%></span>						<em class="wap-more-ico"></em>						</p>';M.checklogin(function(C){if(C){window.IS_LOGIN=true;M.get("route.php?mod=order&action=get_order_address",{},function(G){var F;G=G.reverse();if(v){for(var E=0;E<G.length;E++){if(G[E].address_id==v){F=G[E]}}if(!F){F=G[0]}}else{F=G[0]}var D=M.mstmpl(l,{data:F});if(G.length){i=F.address_id;g.show().append(D)}else{$("#new_address_link").show()}})}else{$("#new_address_container").show()}});var h;$("#zone_picker")[CLICK](function(){new Picker({type:"zone",el:this,onclick:function(C){M.get("route.php?mod=order&action=get_district",{city:C},function(F){if(F.code==0){if(F.data){for(var E in F.data){var D=F.data[E].name;if(!F.data[E].free){if(D.indexOf("*")<0){F.data[E].name="*"+D}}}h=F.data;$("#street_container").show()}else{$("#street_container").hide()}}})}})});$("#street_picker")[CLICK](function(){new Picker({type:"street",el:this,data:h,onclick:function(C){}})});var f=(new Date(server_date*1));var n=f.getFullYear();var A=f.getMonth()+1;var u=f.getDate();var e=f.getHours();var t=f.getMinutes();var y="";var d="";var s={year_sel:$("#year_sel"),month_sel:$("#month_sel"),day_sel:$("#day_sel"),hour_sel:$("#hour_sel"),minute_sel:$("#minute_sel"),region_sel:$("#region_sel"),dis_district:$("#district_sel"),message_input:$("#message_input"),shipping_fee_display:$("#shipping_fee_display"),shipping_fee:$("#shipping_fee")};var z=function(){var C=s.month_sel.val();if(C<10){C="0"+C}return s.year_sel.val()+"-"+C+"-"+s.day_sel.val()};var o=function(){return n+"-"+A+"-"+u};var c=22;var r=10;var a="";$("#date_picker")[CLICK](function(){$("#time_picker").val("");a=false;new Picker({type:"date",el:this,onclick:function(L,K,N){s.year_sel.val(L);s.month_sel.val(K);s.day_sel.val(N);r=10;c=22;var O=(new Date(server_date*1));var H="";var I=z();var D=o();var J=O.getHours();var F=(new Date(window.server_date)).getTime();var G=(new Date(I)).getTime();if(window.HAS_BIG_STAFF||window.HAS_NO_SUGAR_STAFF){if(G-F>3600*1000*24){r=14}else{if(window.HAS_NO_SUGAR_STAFF){a="无糖蛋糕制作需要24小时，所选择日期不能送货"}else{a="大于5磅蛋糕制作需要24小时，所选择日期不能送货"}}}else{if((G-F==3600*1000*24&&J>21)||(G==F&&J<10)){r=14}else{var C=e;var E=t;C+=5;if(D==I){if(E>=30){C+=1}if(C>c){a="制作需要5小时，今天已不能送货"}else{if(e<10){r=14}else{r=C}}}}}if(a){$("#time_picker").val(a)}}})});$("#time_picker")[CLICK](function(){if(a){return}new Picker({type:"time",el:this,beginHour:r,endHour:c,tips:a,onclick:function(C,D){s.hour_sel.val(C);s.minute_sel.val(D)}})});var j=false;$("body").delegate(".pay_container",CLICK,function(){if(j){return}j=true;var D=$(this);var C=D.data("id");D.find("em").trigger(CLICK);$("#pay_id").val(C);setTimeout(function(){j=false},20)});var B=function(){M.get("route.php?mod=order&action=if_address_need_fee",{address_id:i},function(C){if(C.code==0){if(parseInt(C.fee)){s.shipping_fee_display.show()}else{s.shipping_fee_display.hide()}s.shipping_fee.val(C.fee);updateTotalPriceDisplay(C)}})};g.delegate(".address_item",CLICK,function(){var C=$(this);g.find(".address_item").removeClass("ama-item-current");C.addClass("ama-item-current");i=C.data("id");B()}).delegate(".addr_del",CLICK,function(){var D=$(this);var C=D.data("id");M.confirm("确认删除这个地址信息吗？",function(){M.post("route.php?mod=order&action=del_order_address",{id:C},function(E){if(E.code==0){if(window.CURRENT_ADDRESS_ID==C){window.CURRENT_ADDRESS_ID=null}$("#address_"+C).remove()}})});return false}).delegate(".addr_edit",CLICK,function(){var D=$(this);var C=D.data("id");D=$("#address_"+C);CURRENT_ID=C;require(["ui/newaddress"],function(E){E.show({mod:true,id:C,data:{city:D.data("city"),address:D.data("address"),tel:D.data("tel"),contact:D.data("contact"),district:D.data("district")},callback:function(F){JQ.address_container.find(".address_item").removeClass("ama-item-current");i=F;$("#address_"+F).addClass("ama-item-current");B()}})});return false}).delegate(".address_item",CLICK,function(){M.loading();var C=$(this).data("id");location.href="/addressmanager?id="+C});var x=function(){M.post("route.php?mod=order&action=checkout",{card_message:"",vaild_code:"",source:"FROM_MOBILE"},function(C){var D=s.message_input;$("#leaving_message").val(D.val());if(C.code==0){$("#submit_form").submit()}else{p()}})};var m=function(){if(!z()){return false}var C=s.hour_sel.val();if(C>22||C<10){return false}var D=s.minute_sel.val();if(D!=0&&D!=30){return false}return true};var p=function(){M.loadingEnd()};var k=function(E,D){var C=E.parent();C.addClass("animated flash");E.addClass("error-border");$("#scroll_container").scrollTop(D);C[0].addEventListener("webkitAnimationEnd",function(){C.removeClass("animated flash");E.removeClass("error-border")})};var b=function(){if($("#new_address").val()==""){k($("#new_address"),300);return false}if($("#new_contact").val()==""){k($("#new_contact"),350);return false}if(!M.IS_MOBILE($("#new_tel").val())){k($("#new_tel"),400);return false}return true};var q=function(){if(s.region_sel.val()=="0"){k(s.region_sel,300);return false}if(s.dis_district.val()=="0"&&s.dis_district.parent().css("display")!="none"){k(s.dis_district,300);return false}return true};var w=function(F){var D=this;var C;if(i){C=$("#address_"+i)}else{if(!b()){return false}if(!q()){return false}}var E={address_id:i||0,consignee:C?C.data("contact"):$("#new_contact").val(),country:441,city:C?C.data("city"):s.region_sel.val(),address:C?C.data("address"):$("#new_address").val(),district:C?C.data("district"):s.dis_district.val(),mobile:C?C.data("tel"):$("#new_tel").val(),bdate:z(),hour:s.hour_sel.val(),minute:s.minute_sel.val(),message_input:s.message_input.val().substring(0,140),inv_payee:"",inv_content:""};if(!m()){M.confirm("您选择的送货时间或日期不正确，请重新选择");p();return}M.loading();M.post("route.php?action=save_consignee&mod=order",E||{},function(G){if(G.msg=="time error"){M.confirm("您所选择的送货时间距离制作时间不能少于5小时!")}if(G.code!=0){M.confirm("收货信息填写不完整，重新填写后再提交");p();return}if(window.IS_LOGIN){x()}else{var H=$("#new_tel").val();if(!M.IS_MOBILE(H)){M.inputError("new_tel_error");return}M.get("route.php?action=check_user_exsit&mod=account",{username:H},function(I){if(I.exsit){M.confirm("您所使用的手机号已经被注册，请登录后再继续订购",function(){location.href="/login"});p()}else{var J=E.mobile;M.post("route.php?action=auto_register&mod=account",{username:J},function(K){if(K.code==0){setTimeout(function(){x()},100)}else{p()}})}})}})};$("#done_button")[CLICK](function(){w()});$(".pay_sel")[CLICK](function(){$(".pay_sel").removeClass("checked");$(this).addClass("checked")})})();(function(){var b='<% for(var i=0;i<data.length;i++){ %>			<div class="wap-order-item" id="sub_order_<%=data[i].rec_id%>">				<%if(data[i].goods_id == CAT_CAKE) {%>					<img src="'+M.staticDomain+'css/img/cat-little.jpg" class="woi-img">				<% } else {%>				<img src="http://www.mescake.com/themes/default/images/sgoods/<%=data[i].goods_sn.substring(0,3)%>.jpg" class="woi-img">				<% } %>			    <div class="woi-intro-area">				  <p class="woi-title"><%=data[i].goods_name%><span class="woi-tip">(尺寸：<%=data[i].goods_attr%>)</span></p>				  <span class="woi-price" id="sub_total_<%=data[i].rec_id%>"><%=data[i].subtotal%>元</span>				  <div style="padding-top:6px;">					  <em class="minus-ico-me order_des" data-id="<%=data[i].rec_id%>">-</em>					  <input disabled="true" type="text" class="global-input num-input" style="width:30px;" value="<%=data[i].goods_number%>">					  <em class="add-ico-me order_add" data-id="<%=data[i].rec_id%>">+</em>				   </div>				</div>			</div>		   <% } %>';M.get("route.php?mod=order&action=get_order_list",{},function(g){var e=M.mstmpl(b,{data:g.goods_list});var f=g.goods_list.length;if(f==0){location.href=M.touchDomain+"shopcarempty";return}$("#staff_count").html(f);$("#order_price").after(e).html(g.order_total.amount_formated);$("#total_price").html(g.order_total.amount_formated);M.loadingEnd()});var a=$("body");window.updateTotalPriceDisplay=function(e){if(e.order_total==false){location.href=M.touchDomain+"shopcarempty";return}e=e.order_total;$("#total_price").html(e.amount_formated);$("#order_price").html(e.amount_formated)};var c=function(e,d){M.get("route.php",{id:e,num:d,mod:"order",action:"update_cart"},function(f){$("#sub_total_"+e).html(f.result);updateTotalPriceDisplay(f)})};a.delegate(".order_add",CLICK,function(){var f=$(this);var e=f.data("id");var d=parseInt(f.prev().val(),10);d+=1;f.prev().val(d);c(e,d)}).delegate(".order_des",CLICK,function(){var f=$(this);var e=f.data("id");var d=parseInt(f.next().val(),10);d-=1;if(d<1){M.confirm("删除该商品？",function(){M.get("route.php?mod=order&action=drop_shopcart",{id:e},function(g){$(".sub_order_"+e).remove();$("#sub_order_"+e).remove();updateTotalPriceDisplay(g)})},function(){d=1;f.next().val(d)})}else{f.next().val(d);c(e,d)}}).delegate(".order_cancel",CLICK,function(){var f=$(this);var e=f.data("id");var d=f.data("goods");M.get("route.php?mod=order&action=drop_shopcart",{id:e},function(g){$(".sub_order_"+e).remove();$("#sub_order_"+e).remove();updateTotalPriceDisplay(g)});return false})})();